# ETO Protocol Subgraph - Docker Compose
# Chain ID: 69670 | RPC: https://eto.ash.center/rpc
# 
# Usage:
#   Local development: docker-compose up -d
#   AWS production: Use ECS with RDS PostgreSQL

services:
  # Nginx reverse proxy with security & health checks
  nginx:
    image: nginx:alpine
    platform: linux/amd64
    ports:
      - '8000:80'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      graph-node:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  graph-node:
    image: graphprotocol/graph-node:v0.34.1
    platform: linux/amd64
    ports:
      - '8020:8020'  # Admin port for subgraph deployment
      - '8030:8030'  # Index node status
    expose:
      - '8000'
    depends_on:
      postgres:
        condition: service_healthy
      ipfs:
        condition: service_started
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      postgres_host: postgres
      postgres_user: ${POSTGRES_USER:-graph-node}
      postgres_pass: ${POSTGRES_PASSWORD:-let-me-in}
      postgres_db: ${POSTGRES_DB:-graph-node}
      ipfs: 'ipfs:5001'
      # ETO L1 Mainnet - Chain ID 69670
      ethereum: 'eto-l1:${ETHEREUM_RPC_URL:-https://eto.ash.center/rpc}'
      GRAPH_LOG: ${GRAPH_LOG:-info}
      # Low reorg settings for ETO L1 (fast finality)
      ETHEREUM_REORG_THRESHOLD: ${ETHEREUM_REORG_THRESHOLD:-1}
      ETHEREUM_ANCESTOR_COUNT: ${ETHEREUM_ANCESTOR_COUNT:-1}
      # Performance tuning
      GRAPH_ETHEREUM_BLOCK_BATCH_SIZE: 100
      GRAPH_ETHEREUM_MAX_BLOCK_RANGE_SIZE: 1000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  ipfs:
    image: ipfs/kubo:v0.22.0
    platform: linux/amd64
    ports:
      - '5001:5001'  # API port for subgraph uploads
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      IPFS_PROFILE: server
    restart: unless-stopped

  postgres:
    image: postgres:14-alpine
    platform: linux/amd64
    expose:
      - '5432'
    command:
      - "postgres"
      - "-cshared_preload_libraries=pg_stat_statements"
      - "-cmax_connections=200"
      - "-cwork_mem=64MB"
      - "-cmaintenance_work_mem=256MB"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-graph-node}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-let-me-in}
      POSTGRES_DB: ${POSTGRES_DB:-graph-node}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-graph-node}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ipfs_data:
  postgres_data:
