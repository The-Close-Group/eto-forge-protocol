services:
  # Nginx reverse proxy with security
  nginx:
    image: nginx:alpine
    platform: linux/amd64
    ports:
      - '8000:80'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - graph-node
    restart: unless-stopped

  graph-node:
    image: graphprotocol/graph-node:latest
    platform: linux/amd64
    ports:
      - '8020:8020'  # Admin port for subgraph deployment
      - '8030:8030'  # Index node status
    expose:
      - '8000'
    depends_on:
      - ipfs
      - postgres
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      postgres_host: postgres
      postgres_user: ${POSTGRES_USER:-graph-node}
      postgres_pass: ${POSTGRES_PASSWORD:-let-me-in}
      postgres_db: ${POSTGRES_DB:-graph-node}
      ipfs: 'ipfs:5001'
      ethereum: 'eto-l1:${ETHEREUM_RPC_URL:-https://eto.ash.center/rpc}'
      GRAPH_LOG: ${GRAPH_LOG:-info}
      ETHEREUM_REORG_THRESHOLD: ${ETHEREUM_REORG_THRESHOLD:-1}
      ETHEREUM_ANCESTOR_COUNT: ${ETHEREUM_ANCESTOR_COUNT:-1}
    restart: unless-stopped

  ipfs:
    image: ipfs/kubo:v0.14.0
    platform: linux/amd64
    ports:
      - '5001:5001'  # API port for subgraph uploads
    volumes:
      - ipfs_data:/data/ipfs
    restart: unless-stopped

  postgres:
    image: postgres:14
    platform: linux/amd64
    # Don't expose port publicly - only internal access
    expose:
      - '5432'
    command:
      - "postgres"
      - "-cshared_preload_libraries=pg_stat_statements"
      - "-cmax_connections=200"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-graph-node}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-let-me-in}
      POSTGRES_DB: ${POSTGRES_DB:-graph-node}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  ipfs_data:
  postgres_data:
